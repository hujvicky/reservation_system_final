import csv
# 📌 修正：將 app 和 db 的導入移到需要時才導入
from models import ReservationRecord
from datetime import datetime

# 報表匯出時的檔案名稱
OUTPUT_FILENAME = "reservation_report.csv" 

def export_data_to_csv():
    """從 ReservationRecord 資料庫中讀取所有數據並匯出到 CSV 檔案"""
    
    # 📌 修正：在函數內部導入 app 和 db，避免循環導入
    from app import app, db 
    
    with app.app_context():
        # 查詢所有預訂紀錄
        all_reservations = ReservationRecord.query.all()
        
        # 標頭 (Header) - 與 models.py/admin.html 保持一致
        fieldnames = [
            'ID', 
            'Table_ID', 
            'Login_ID',            
            'Employee_Name', 
            'Seats_Taken', 
            'Timestamp'
        ]
        
        # 使用 'utf-8-sig' 編碼，確保 Excel 打開時中文不會亂碼 (Windows 兼容)
        with open(OUTPUT_FILENAME, 'w', newline='', encoding='utf-8-sig') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            
            writer.writeheader()
            
            for record in all_reservations:
                data = record.to_dict()
                
                # 寫入時對應標頭
                writer.writerow({
                    'ID': data['id'],
                    'Table_ID': data['table_id'],
                    'Login_ID': data['login_id'],
                    'Employee_Name': data['employee_name'],
                    'Seats_Taken': data['seats_taken'],
                    'Timestamp': data['timestamp'] 
                })
        
        print(f"\n✅ Data exported successfully to: {OUTPUT_FILENAME}")
        print(f"Total {len(all_reservations)} records exported.")

if __name__ == '__main__':
    # 這裡的代碼不會被 Flask 伺服器運行時調用
    export_data_to_csv()
