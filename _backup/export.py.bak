import csv
# ğŸ“Œ ä¿®æ­£ï¼šå°‡ app å’Œ db çš„å°å…¥ç§»åˆ°éœ€è¦æ™‚æ‰å°å…¥
from models import ReservationRecord
from datetime import datetime

# å ±è¡¨åŒ¯å‡ºæ™‚çš„æª”æ¡ˆåç¨±
OUTPUT_FILENAME = "reservation_report.csv" 

def export_data_to_csv():
    """å¾ ReservationRecord è³‡æ–™åº«ä¸­è®€å–æ‰€æœ‰æ•¸æ“šä¸¦åŒ¯å‡ºåˆ° CSV æª”æ¡ˆ"""
    
    # ğŸ“Œ ä¿®æ­£ï¼šåœ¨å‡½æ•¸å…§éƒ¨å°å…¥ app å’Œ dbï¼Œé¿å…å¾ªç’°å°å…¥
    from app import app, db 
    
    with app.app_context():
        # æŸ¥è©¢æ‰€æœ‰é è¨‚ç´€éŒ„
        all_reservations = ReservationRecord.query.all()
        
        # æ¨™é ­ (Header) - èˆ‡ models.py/admin.html ä¿æŒä¸€è‡´
        fieldnames = [
            'ID', 
            'Table_ID', 
            'Login_ID',            
            'Employee_Name', 
            'Seats_Taken', 
            'Timestamp'
        ]
        
        # ä½¿ç”¨ 'utf-8-sig' ç·¨ç¢¼ï¼Œç¢ºä¿ Excel æ‰“é–‹æ™‚ä¸­æ–‡ä¸æœƒäº‚ç¢¼ (Windows å…¼å®¹)
        with open(OUTPUT_FILENAME, 'w', newline='', encoding='utf-8-sig') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            
            writer.writeheader()
            
            for record in all_reservations:
                data = record.to_dict()
                
                # å¯«å…¥æ™‚å°æ‡‰æ¨™é ­
                writer.writerow({
                    'ID': data['id'],
                    'Table_ID': data['table_id'],
                    'Login_ID': data['login_id'],
                    'Employee_Name': data['employee_name'],
                    'Seats_Taken': data['seats_taken'],
                    'Timestamp': data['timestamp'] 
                })
        
        print(f"\nâœ… Data exported successfully to: {OUTPUT_FILENAME}")
        print(f"Total {len(all_reservations)} records exported.")

if __name__ == '__main__':
    # é€™è£¡çš„ä»£ç¢¼ä¸æœƒè¢« Flask ä¼ºæœå™¨é‹è¡Œæ™‚èª¿ç”¨
    export_data_to_csv()
