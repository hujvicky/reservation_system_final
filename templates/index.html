<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Seating Map • Reservations</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #seating-map{
      display:grid;
      grid-template-columns:repeat(6,130px) 80px repeat(6,130px);
      grid-auto-rows:130px;
      gap:15px;
      padding:20px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      width:max-content;
      margin:0 auto;
    }
    .table-card{
      width:130px;height:130px;border-radius:50%;border:4px solid;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;cursor:pointer;user-select:none;
      transition:transform .15s ease, box-shadow .15s ease;
      text-align:center;line-height:1.15;padding:10px
    }
    .table-card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .aisle{grid-column:7;width:100%;height:100%;min-height:130px;border-left:3px dashed #bbb;border-right:3px dashed #bbb;position:relative}
    .aisle::before{content:'AISLE';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-90deg);font-size:12px;color:#999;letter-spacing:2px}
    
    /* === 10個群組顏色 === */
    .group-main    { background:#fecaca; border-color:#ef4444; }
    .group-eero    { background:#bbf7d0; border-color:#22c55e; }
    .group-ops     { background:#bae6fd; border-color:#0ea5e9; }
    .group-hw      { background:#d8b4fe; border-color:#9333ea; }
    .group-sw      { background:#fef08a; border-color:#ca8a04; }
    .group-ai      { background:#fed7aa; border-color:#f97316; }
    .group-devices { background:#99f6e4; border-color:#14b8a6; }
    .group-others  { background:#e5e7eb; border-color:#6b7280; }
    .group-tpm     { background:#c7d2fe; border-color:#4f46e5; }
    .group-sidewalk{ background:#fbcfe8; border-color:#ec4899; }

    .dept-name {
      display: block;
      font-size: 13px;
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: 4px;
      color: #1f2937;
    }

    .status-disabled{opacity:.55;cursor:not-allowed;pointer-events:none}
    
    /* === (NEW) Tooltip 樣式 === */
    #table-tooltip {
      position: fixed; /* 跟隨頁面，而非地圖 */
      display: none;
      padding: 8px 12px;
      background: rgba(30, 41, 59, 0.95); /* 深藍灰背景 */
      color: white;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
      font-weight: 500;
      z-index: 2000;
      pointer-events: none; /* 讓滑鼠可以穿透 tooltip，不會干擾 hover */
      box-shadow: 0 5px 15px rgba(0,0,0,.2);
      max-width: 280px;
    }
    #table-tooltip b {
      color: #fef08a; /* 標題用黃色 */
      font-weight: 700;
    }
    /* === (NEW) End Tooltip 樣式 === */

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-backdrop.show{display:flex}
    .modal-card{width:min(92vw,460px);background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.25);padding:18px 18px 14px}
    .modal-card h3{margin:0 0 12px;font-size:18px;font-weight:800}
    .modal-row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .modal-row label{font-size:12px;color:#374151}
    .modal-row input,.modal-row select{border:1px solid #d0d5dd;border-radius:10px;padding:10px 12px;font-size:14px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    .btn{border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;border:1px solid transparent}
    .btn.secondary{background:#fff;border-color:#d0d5dd;color:#374151}
    .btn.primary{background:#4f46e5;color:#fff}
    .btn.primary[disabled]{opacity:.6;cursor:not-allowed}
    .count{display:block;font-weight:600;font-size:12px;color:#374151}
    .full-width-fix{
      width:100%;
      background-color:rgba(243,244,f6,.95);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="w-full flex flex-col items-center">
    <div class="mx-auto" style="width:max-content;">
      <div class="w-full flex justify-center mb-6">
        <div class="w-[900px] py-4 rounded-2xl border-4 border-red-500 bg-white font-extrabold text-red-500 text-4xl tracking-[0.25em] text-center shadow-[inset_0_0_0_6px_rgba(239,68,68,0.15)]">
          S T A G E
        </div>
      </div>
      <div id="seating-map" aria-label="Seating map"></div>
      <div class="mt-4">
        <div class="w-[120px] h-[80px] border-4 border-green-600 rounded-md flex flex-col items-center justify-center bg-white shadow-md">
          <span class="text-green-600 font-bold text-sm tracking-wide leading-none">ENTRANCE</span>
          <span class="text-gray-500 text-xs leading-none mt-1">/ EXIT</span>
        </div>
      </div>
    </div>
  </div>

  <div id="reserve-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="reserve-title">
    </div>

  <div id="table-tooltip" role="tooltip"></div>


  <script>
    const TOTAL=108, PER_ROW=12;

    // === (NEW) 全域變數，用來儲存訂位名單 ===
    // 格式會是: { 1: ["Panos", "Satya"], 2: [], ... }
    let reservationDetails = {};

    // === 桌位群組定義 (跟之前一樣) ===
    const groupConfig = {
      'MAIN':    { displayName: 'Main',      cssClass: 'group-main' },
      'EERO':    { displayName: 'eero',      cssClass: 'group-eero' },
      'OPS':     { displayName: 'Operation', cssClass: 'group-ops' },
      'HW':      { displayName: 'Hardware',  cssClass: 'group-hw' },
      'SW':      { displayName: 'Software',  cssClass: 'group-sw' },
      'AI':      { displayName: 'AI Team',   cssClass: 'group-ai' },
      'DEVICES': { displayName: 'Devices',   cssClass: 'group-devices' },
      'OTHERS':  { displayName: 'Others',    cssClass: 'group-others' },
      'TPM':     { displayName: 'TPM',       cssClass: 'group-tpm' },
      'SIDEWALK':{ displayName: 'Sidewalk',  cssClass: 'group-sidewalk' }
    };
    const tableGroupConfig = {
      'MAIN':  [6, 7],
      'EERO': [1, 2, 3, 4, 5, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
      'OPS': [21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40],
      'HW': [41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55],
      'SW': [56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73],
      'AI': [74, 75, 76, 77, 78, 79, 80, 81, 82],
      'DEVICES': [83, 84, 85, 86, 87, 88, 89, 90, 91, 92],
      'OTHERS': [93, 94, 95, 96, 97],
      'TPM': [98, 99, 100, 101, 102],
      'SIDEWALK': [103, 104, 105, 106, 107, 108]
    };
    const tableIdToGroupMap = {};
    const defaultGroupInfo = groupConfig['OTHERS']; 
    for (const groupKey in tableGroupConfig) {
      if (groupConfig[groupKey]) {
        const groupInfo = groupConfig[groupKey];
        const tableIds = tableGroupConfig[groupKey];
        tableIds.forEach(tableId => {
          tableIdToGroupMap[tableId] = groupInfo;
        });
      }
    }
    // === (END) 桌位群組定義 ===


    function showMessage(t,type='info'){
      // ... (內容不變)
    }

    // Build seating grid (內容不變)
    const wrap=document.getElementById('seating-map');
    let cnt=0;
    for(let i=1;i<=TOTAL;i++){
      const groupInfo = tableIdToGroupMap[i] || defaultGroupInfo; 
      const d=document.createElement('div');
      d.className='table-card';
      d.dataset.tableId=i;
      d.classList.add(groupInfo.cssClass);
      d.innerHTML=`<div>
          <span class="dept-name">${groupInfo.displayName}</span>
          Table ${i}
          <span class="count" data-left="${i}">(10 left)</span>
        </div>`;
      wrap.appendChild(d);
      cnt++;
      if(cnt%6===0 && cnt%12!==0){
        const a=document.createElement('div');a.className='aisle';wrap.appendChild(a);
      }
      if(cnt===12) cnt=0;
    }

    // === (MODIFIED) 修改 updateCounts 來儲存訂位名單 ===
    async function updateCounts(){
      try{
        const r=await fetch('/api/status');
        if(!r.ok) return;
        const { tables } = await r.json();

        const newDetails = {}; // 建立一個新的暫存 map

        tables.forEach(t=>{
          // 更新座位數 (舊邏輯)
          const card=document.querySelector(`.table-card[data-table-id="${t.table_id}"]`);
          const span=document.querySelector(`.count[data-left="${t.table_id}"]`);
          if(card && span){
            span.textContent=`(${t.seats_left} left)`;
            card.classList.toggle('status-disabled', t.seats_left <= 0);
          }
          
          // (NEW) 儲存訂位名單
          // 假設 API 回傳 t.reservations = ["Name 1", "Name 2"]
          newDetails[t.table_id] = t.reservations || [];
        });

        // (NEW) 用新的資料覆蓋全域變數
        reservationDetails = newDetails;

      }catch(e){ /* ignore */ }
    }
    updateCounts();
    setInterval(updateCounts,3000);


    // === (NEW) Tooltip 事件監聽 ===
    const tooltip = document.getElementById('table-tooltip');

    // 輔助函式：更新 tooltip 位置 (避免超出螢幕)
    function updateTooltipPosition(e) {
      let x = e.pageX + 15; // 游標右側 15px
      let y = e.pageY + 15; // 游標下方 15px

      // 檢查是否超出視窗右邊界
      if (x + tooltip.offsetWidth + 20 > window.innerWidth) {
        x = e.pageX - tooltip.offsetWidth - 15; // 翻轉到游標左側
      }
      // 檢查是否超出視窗下邊界
      if (y + tooltip.offsetHeight + 20 > window.innerHeight) {
        y = e.pageY - tooltip.offsetHeight - 15; // 翻轉到游標上側
      }

      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }

    // 1. 滑鼠移入桌子
    wrap.addEventListener('mouseover', (e) => {
      const card = e.target.closest('.table-card');
      if (!card) {
        tooltip.style.display = 'none'; // 如果不是移到桌子上，隱藏
        return;
      }
      
      const tableId = card.dataset.tableId;
      const names = reservationDetails[tableId]; // 從全域變數中取得名單
      const groupInfo = tableIdToGroupMap[tableId] || defaultGroupInfo;

      // 產生 tooltip 內容
      if (!names || names.length === 0) {
        tooltip.innerHTML = `<b>Table ${tableId} (${groupInfo.displayName})</b><br>Available. No reservations.`;
      } else {
        tooltip.innerHTML = `<b>Table ${tableId} (${groupInfo.displayName})</b><br>${names.join('<br>')}`;
      }
      
      tooltip.style.display = 'block'; // 顯示 tooltip
      updateTooltipPosition(e); // 設定初始位置
    });

    // 2. 滑鼠在桌子上移動
    wrap.addEventListener('mousemove', (e) => {
      // 只有在 tooltip 可見時才更新位置
      if (tooltip.style.display === 'block') {
        updateTooltipPosition(e);
      }
    });

    // 3. 滑鼠移出座位圖區域
    wrap.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none'; // 隱藏 tooltip
    });
    // === (NEW) End Tooltip 事件 ===


    // Idempotency Key (內容不變)
    function makeIdemKey(){
      // ...
    }

    // Modal elements (內容不變)
    const modal=document.getElementById('reserve-modal');
    // ...

    // (Modal 相關的 function 和 click 事件，全部不變)
    // ...
  </script>
</body>
</html>
