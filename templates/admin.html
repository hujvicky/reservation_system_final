<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel • Reservations</title>
  <script src="cdn.tailwindcss.com"></script> Note: Please be mindful when interacting with displayed links.
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Admin Panel</h1>
      <div class="flex gap-3">
        <a href="/index.html" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Go to Seating Map</a>
        <a href="/api/reservations.csv" class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Export Report (CSV)</a>
        <button id="logoutBtn" class="px-3 py-2 rounded bg-red-500 text-white hover:bg-red-600">Logout</button>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
      <div class="text-lg font-semibold mb-3" id="title">Reservation Records</div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-gray-100 text-gray-700">
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Table ID</th>
              <th class="px-3 py-2 text-left">Login ID</th>
              <th class="px-3 py-2 text-left">Employee Name</th>
              <th class="px-3 py-2 text-left">Seats Reserved</th>
              <th class="px-3 py-2 text-left">Timestamp (Taiwan Time)</th>
              <th class="px-3 py-2 text-left">Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 台灣時區格式化函數
    function formatTaiwanTime(dateString) {
      try {
        return new Date(dateString).toLocaleString('en-US', {
          timeZone: 'Asia/Taipei',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      } catch (error) {
        console.error('Time formatting error:', error);
        return dateString;
      }
    }

    // 驗證登入狀態
    function checkAuth() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }

      // 驗證 token
      fetch('/api/admin/verify', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
      .then(response => response.json())
      .then(result => {
        if (!result.success) {
          localStorage.removeItem('adminToken');
          window.location.href = '/login.html';
        }
      })
      .catch(() => {
        localStorage.removeItem('adminToken');
        window.location.href = '/login.html';
      });

      return true;
    }

    // 登出功能
    document.getElementById('logoutBtn').addEventListener('click', function() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('adminToken');
        window.location.href = '/login.html';
      }
    });

    // 頁面載入時檢查驗證
    if (!checkAuth()) {
      throw new Error('Authentication required');
    }

    function fmtTableId(n){ return 'T' + String(n).padStart(3,'0'); }

    async function load(){
      const token = localStorage.getItem('adminToken');

      try {
        const r = await fetch('/api/reservations?page=1&page_size=500', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (r.status === 401) {
          localStorage.removeItem('adminToken');
          alert('Session expired. Please login again.');
          window.location.href = '/login.html';
          return;
        }

        if (!r.ok) {
          throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }

        const { data } = await r.json();
        document.getElementById('title').textContent = `Reservation Records (Total: ${data.length})`;

        const rows = data.map((d, idx) => {
          const ts = formatTaiwanTime(d.created_at);
          const canReduceMax = Math.max(0, Number(d.seats_taken) - 1);
          const reduceSelect = canReduceMax > 0
            ? `<select class="border rounded px-2 py-1" data-reduce-select="${d.id}">
                 ${Array.from({length: canReduceMax}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
               </select>
               <button class="ml-2 px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" data-reduce="${d.id}" data-max="${canReduceMax}">Reduce</button>`
            : `<span class="text-gray-400">—</span>`;

          return `<tr class="${idx%2?'bg-gray-50':''}">
            <td class="px-3 py-2">${idx+1}</td>
            <td class="px-3 py-2 font-medium">${fmtTableId(d.table_id)}</td>
            <td class="px-3 py-2">${d.login_id||''}</td>
            <td class="px-3 py-2">${d.employee_name||''}</td>
            <td class="px-3 py-2">${d.seats_taken}</td>
            <td class="px-3 py-2">${ts}</td>
            <td class="px-3 py-2">
              <div class="flex items-center gap-2">
                ${reduceSelect}
                <button class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600" data-cancel="${d.id}">Cancel</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        document.getElementById('rows').innerHTML = rows;

        // 取消預約事件
        document.querySelectorAll('[data-cancel]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.getAttribute('data-cancel');
            if(!confirm('Cancel this reservation entirely?')) return;

            const token = localStorage.getItem('adminToken');
            const response = await fetch('/api/cancel', {
              method:'POST',
              headers:{
                'Content-Type':'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({reservation_id:id})
            });

            if (response.status === 401) {
              localStorage.removeItem('adminToken');
              alert('Session expired. Please login again.');
              window.location.href = '/login.html';
              return;
            }

            if (response.ok) {
              load(); // 重新載入資料
            } else {
              alert('Failed to cancel reservation.');
            }
          });
        });

        // 減少座位事件
        document.querySelectorAll('[data-reduce]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.getAttribute('data-reduce');
            const sel = document.querySelector(`[data-reduce-select="${id}"]`);
            const n = Number(sel && sel.value);
            if(!n || n < 1){ alert('Please select a number to reduce.'); return; }

            const token = localStorage.getItem('adminToken');
            const res = await fetch('/api/reduce', {
              method:'POST',
              headers:{
                'Content-Type':'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({reservation_id:id, reduce_by:n})
            });

            if (res.status === 401) {
              localStorage.removeItem('adminToken');
              alert('Session expired. Please login again.');
              window.location.href = '/login.html';
              return;
            }

            const data = await res.json();
            if(!data.success){
              alert(data.message || 'Failed to reduce seats.');
              return;
            }

            load(); // 重新載入資料
          });
        });

      } catch (error) {
        console.error('載入資料失敗:', error);
        document.getElementById('rows').innerHTML = `
          <tr>
            <td colspan="7" class="p-4 text-center text-red-600">
              Failed to load reservation data. Please try again.
            </td>
          </tr>
        `;
      }
    }

    // 載入資料
    load();
  </script>
</body>
</html>
